---
import {
  AvButton,
  AvCard,
  AvContainer,
  AvDrawer,
  AvEmptyState,
  AvInput,
  AvLoading,
  AvSelect,
  AvTextarea,
} from "@ansiversa/components";
import { actions } from "astro:actions";
import AppShell from "../../../layouts/AppShell.astro";
import type { PortfolioProjectDetail } from "../../../modules/portfolio-creator/types";
import { TEMPLATE_OPTIONS, sectionLabels } from "../../../modules/portfolio-creator/helpers";
import {
  PORTFOLIO_LIMITS,
  PORTFOLIO_MAX,
  PORTFOLIO_MONTH_OPTIONS,
  getPortfolioYearOptions,
} from "../../../modules/portfolio-creator/constraints";

const projectId = Astro.params.id ?? "";
const isPaid = Astro.locals.user?.isPaid === true;
let projectData: PortfolioProjectDetail | null = null;
let loadError: string | null = null;
let isPaywall = false;

try {
  const result = await Astro.callAction(actions.portfolioCreator.getProject, { projectId });
  const data = (result as any)?.data ?? (result as any) ?? null;
  projectData = data as PortfolioProjectDetail;
} catch (err) {
  loadError = (err as Error)?.message ?? "Unable to load portfolio.";
  isPaywall = loadError.toLowerCase().includes("upgrade to pro");
}

const title = projectData?.project?.title
  ? `Edit ${projectData.project.title} – Portfolio Creator`
  : "Edit Portfolio – Portfolio Creator";
const description = "Edit your portfolio content and preview the public page.";

const initialState = {
  activeProject: projectData,
  activeProjectId: projectData?.project?.id ?? projectId,
  projects: [],
  isPaid,
  paywallMessage: null,
  templateOptions: TEMPLATE_OPTIONS,
};

const sectionOrder = [
  "profile",
  "about",
  "featuredProjects",
  "experience",
  "skills",
  "education",
  "certifications",
  "achievements",
  "contact",
] as const;
const yearOptions = getPortfolioYearOptions();
const monthOptions = PORTFOLIO_MONTH_OPTIONS;
---

<AppShell title={title} description={description}>
  <section class="av-section">
    <AvContainer size="default">
      <div
        class="av-auth-stack-lg"
        x-data="$store.portfolioCreator"
        x-init="init && init(JSON.parse($el.dataset.initial))"
        data-initial={JSON.stringify(initialState)}
      >
        {loadError ? (
          <div class="av-auth-stack-md">
            <AvEmptyState headline="Unable to load portfolio" description={loadError} />
            <AvButton href="/app/portfolios" variant="ghost">Back to portfolios</AvButton>
            {isPaywall ? (
              <AvButton href="https://ansiversa.com/pricing" variant="primary">View pricing</AvButton>
            ) : null}
          </div>
        ) : (
          <>
            <AvCard>
              <div class="av-auth-stack-md">
                <div class="av-auth-stack-xs">
                  <p class="av-kicker">Portfolio Creator</p>
                  <h1 class="av-section-title">Edit portfolio</h1>
                  <p class="av-text-soft">Update details, manage sections, and preview the public page.</p>
                </div>

                <form class="av-auth-stack-sm" @submit.prevent="saveProjectMeta()">
                  <div class="av-portfolio-form-grid">
                    <AvInput
                      label="Portfolio title"
                      name="portfolio-title"
                      placeholder="Portfolio name"
                      x-model="projectMeta.title"
                      maxlength={PORTFOLIO_MAX.projectTitle}
                      required
                    />
                    <p class="av-form-hint" x-text="`${(projectMeta.title || '').length} / ${PORTFOLIO_MAX.projectTitle}`"></p>
                    <AvInput
                      label="Slug"
                      name="portfolio-slug"
                      placeholder="your-name"
                      x-model="projectMeta.slug"
                      maxlength={PORTFOLIO_MAX.slug}
                      required
                    />
                    <p class="av-form-hint" x-text="`${(projectMeta.slug || '').length} / ${PORTFOLIO_MAX.slug}`"></p>
                    <AvSelect
                      label="Visibility"
                      name="portfolio-visibility"
                      x-model="projectMeta.visibility"
                    >
                      <option value="public">Public</option>
                      <option value="unlisted">Unlisted</option>
                      <option value="private">Private</option>
                    </AvSelect>
                  </div>
                  <div class="av-portfolio-template-grid">
                    <template x-for="template in templateOptions" :key="template.key">
                      <button
                        class="av-portfolio-template-card"
                        :class="projectMeta.themeKey === template.key ? 'is-selected' : ''"
                        type="button"
                        @click.prevent="selectProjectTemplate(template.key)"
                        :disabled="isTemplateLocked(template.key)"
                      >
                        <div class="av-row-between">
                          <p class="av-card-heading" x-text="template.label"></p>
                          <span class="av-badge av-badge-soft" x-show="template.tier === 'pro' && !isPaid" x-cloak>Pro</span>
                        </div>
                        <p class="av-text-soft" x-text="template.tier === 'pro' ? 'Included in Pro' : 'Free access'"></p>
                      </button>
                    </template>
                  </div>
                  <div class="av-row-wrap" x-show="paywallMessage" x-cloak>
                    <p class="av-text-soft av-m-0" x-text="paywallMessage"></p>
                    <AvButton href="https://ansiversa.com/pricing" variant="ghost" size="sm">
                      View pricing
                    </AvButton>
                  </div>

                  <div class="av-row-wrap">
                    <AvButton type="submit" :disabled="loading">Save details</AvButton>
                    <AvButton type="button" variant="ghost" @click.prevent="togglePublish()" :disabled="loading">
                      <span x-text="projectMeta.isPublished ? 'Unpublish' : 'Publish'"></span>
                    </AvButton>
                    <AvButton
                      type="button"
                      variant="ghost"
                      href="#"
                      x-bind:href="`/${projectMeta.slug}`"
                      target="_blank"
                    >
                      View public
                    </AvButton>
                  </div>
                </form>
              </div>
            </AvCard>

            <div class="av-portfolio-editor">
              <div class="av-portfolio-editor__left">
                <AvCard className="av-auth-stack-sm">
                  <div class="av-auth-stack-xxs">
                    <h2 class="av-card-heading">Sections</h2>
                    <p class="av-text-soft">Open a section to edit its content.</p>
                  </div>
                  <div class="av-portfolio-section-list">
                    {sectionOrder.map((key) => (
                      <button
                        type="button"
                        class="av-portfolio-section-button"
                        :class={`activeSectionKey === '${key}' ? 'is-active' : ''`}
                        @click.prevent={`openSection('${key}')`}
                      >
                        <span>{sectionLabels[key]}</span>
                        <span class="av-portfolio-section-button__meta">
                          <template x-if="activeProject">
                            <span
                              class="av-portfolio-section-status"
                              x-bind:title={`(activeProject.sections.find(section => section.key === '${key}')?.isEnabled ?? true) ? 'Enabled' : 'Hidden'`}
                            >
                              <svg
                                class="av-portfolio-status-icon"
                                viewBox="0 0 24 24"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                                aria-hidden="true"
                                x-show={`(activeProject.sections.find(section => section.key === '${key}')?.isEnabled ?? true)`}
                              >
                                <path
                                  d="M2 12C3.8 8.3 7.6 6 12 6C16.4 6 20.2 8.3 22 12C20.2 15.7 16.4 18 12 18C7.6 18 3.8 15.7 2 12Z"
                                  stroke="currentColor"
                                  stroke-width="1.6"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                ></path>
                                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6"></circle>
                              </svg>
                              <svg
                                class="av-portfolio-status-icon"
                                viewBox="0 0 24 24"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                                aria-hidden="true"
                                x-show={`!(activeProject.sections.find(section => section.key === '${key}')?.isEnabled ?? true)`}
                              >
                                <path
                                  d="M3 3L21 21"
                                  stroke="currentColor"
                                  stroke-width="1.6"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                ></path>
                                <path
                                  d="M10.6 6.2C11.1 6.1 11.5 6 12 6C16.4 6 20.2 8.3 22 12C21.4 13.2 20.5 14.3 19.5 15.2"
                                  stroke="currentColor"
                                  stroke-width="1.6"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                ></path>
                                <path
                                  d="M14.8 14.8C14.1 15.6 13.1 16 12 16C9.8 16 8 14.2 8 12C8 10.9 8.4 9.9 9.2 9.2"
                                  stroke="currentColor"
                                  stroke-width="1.6"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                ></path>
                                <path
                                  d="M2 12C2.7 10.6 3.7 9.3 4.9 8.3"
                                  stroke="currentColor"
                                  stroke-width="1.6"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                ></path>
                              </svg>
                              <span class="av-visually-hidden" x-text={`(activeProject.sections.find(section => section.key === '${key}')?.isEnabled ?? true) ? 'Enabled' : 'Hidden'`}></span>
                            </span>
                          </template>
                        </span>
                      </button>
                    ))}
                  </div>
                </AvCard>
              </div>

              <div class="av-portfolio-editor__right">
                <AvCard>
                  <div class="av-auth-stack-xs">
                    <h2 class="av-card-heading">Live preview</h2>
                    <p class="av-text-soft">Preview updates after you save changes.</p>
                  </div>
                  <div class="av-portfolio-preview-frame">
                    <iframe title="Portfolio preview" x-bind:src="previewSrc"></iframe>
                  </div>
                </AvCard>
              </div>
            </div>
          </>
        )}

        <AvLoading x-show="loading" x-cloak label="Saving…" />

        <template x-if="drawerOpen">
          <div
            class="av-drawer-overlay"
            @click.self="closeDrawer()"
            @keydown.escape.window="closeDrawer()"
            @close-drawer="closeDrawer()"
            x-cloak
          >
            <AvDrawer title="Edit section" description="Update section content and save.">
              <div class="av-auth-stack-md">
                <div class="av-auth-stack-xs">
                  <p class="av-kicker" x-text="getSectionLabel(activeSectionKey)"></p>
                  <p class="av-text-soft">Save to refresh the preview.</p>
                </div>

                <template x-if="activeSectionKey === 'profile'">
                  <form class="av-auth-stack-sm" @submit.prevent="saveActiveSection()">
                    <AvInput label="Full name" name="full-name" x-model="formData.fullName" maxlength={PORTFOLIO_MAX.profileFullName} @input={`enforceLimit('fullName', ${PORTFOLIO_MAX.profileFullName})`} required />
                    <p class="av-form-hint" x-text="`${(formData.fullName || '').length} / ${PORTFOLIO_MAX.profileFullName}`"></p>
                    <AvInput label="Headline" name="headline" x-model="formData.headline" maxlength={PORTFOLIO_MAX.profileHeadline} @input={`enforceLimit('headline', ${PORTFOLIO_MAX.profileHeadline})`} />
                    <p class="av-form-hint" x-text="`${(formData.headline || '').length} / ${PORTFOLIO_MAX.profileHeadline}`"></p>
                    <AvInput label="Location" name="location" x-model="formData.location" maxlength={PORTFOLIO_MAX.profileLocation} @input={`enforceLimit('location', ${PORTFOLIO_MAX.profileLocation})`} />
                    <div class="av-portfolio-form-grid">
                      <AvInput label="Email" type="email" name="email" x-model="formData.email" maxlength={PORTFOLIO_MAX.profileEmail} @input={`enforceLimit('email', ${PORTFOLIO_MAX.profileEmail})`} />
                      <AvInput label="Phone" type="tel" name="phone" x-model="formData.phone" maxlength={PORTFOLIO_MAX.profilePhone} @input={`enforceLimit('phone', ${PORTFOLIO_MAX.profilePhone})`} />
                    </div>
                    <AvInput label="Website" type="url" name="website" x-model="formData.website" maxlength={PORTFOLIO_MAX.profileWebsite} @input={`enforceLimit('website', ${PORTFOLIO_MAX.profileWebsite})`} />
                    <div class="av-portfolio-form-grid">
                      <AvInput label="GitHub" type="url" name="github" x-model="formData.github" maxlength={PORTFOLIO_MAX.profileGithub} @input={`enforceLimit('github', ${PORTFOLIO_MAX.profileGithub})`} />
                      <AvInput label="LinkedIn" type="url" name="linkedin" x-model="formData.linkedin" maxlength={PORTFOLIO_MAX.profileLinkedin} @input={`enforceLimit('linkedin', ${PORTFOLIO_MAX.profileLinkedin})`} />
                    </div>
                  </form>
                </template>

                <template x-if="activeSectionKey === 'about'">
                  <form class="av-auth-stack-sm" @submit.prevent="saveActiveSection()">
                    <AvTextarea
                      label="About"
                      name="about-text"
                      rows={6}
                      x-model="formData.text"
                      maxlength={PORTFOLIO_MAX.aboutText}
                      @input={`enforceLimit('text', ${PORTFOLIO_MAX.aboutText})`}
                    />
                    <p class="av-form-hint" x-text="`${(formData.text || '').length} / ${PORTFOLIO_MAX.aboutText}`"></p>
                  </form>
                </template>

                <template x-if="activeSectionKey === 'skills'">
                  <form class="av-auth-stack-sm" @submit.prevent="saveActiveSection()">
                    <template x-for="(group, index) in formData.groups" :key="index">
                      <div class="av-auth-stack-xs">
                        <AvInput label="Group name" name="group-name" x-model="group.name" maxlength={PORTFOLIO_MAX.skillsGroupName} @input={`enforceLimit('groups.' + index + '.name', ${PORTFOLIO_MAX.skillsGroupName})`} />
                        <AvTextarea
                          label="Items (one per line)"
                          name="group-items"
                          rows={3}
                          x-model="group.items"
                          @input={`enforceLineLimit('groups.' + index + '.items', ${PORTFOLIO_MAX.skillItem}, 12)`}
                        />
                        <p class="av-form-hint">Each skill max {PORTFOLIO_MAX.skillItem} characters.</p>
                      </div>
                    </template>
                  </form>
                </template>

                <template x-if="activeSectionKey === 'contact'">
                  <form class="av-auth-stack-sm" @submit.prevent="saveActiveSection()">
                    <AvInput
                      label="Call to action title"
                      name="cta-title"
                      x-model="formData.callToActionTitle"
                      maxlength={PORTFOLIO_MAX.ctaTitle}
                      @input={`enforceLimit('callToActionTitle', ${PORTFOLIO_MAX.ctaTitle})`}
                    />
                    <p class="av-form-hint" x-text="`${(formData.callToActionTitle || '').length} / ${PORTFOLIO_MAX.ctaTitle}`"></p>
                    <AvTextarea
                      label="Call to action text"
                      name="cta-text"
                      rows={4}
                      x-model="formData.callToActionText"
                      maxlength={PORTFOLIO_MAX.ctaText}
                      @input={`enforceLimit('callToActionText', ${PORTFOLIO_MAX.ctaText})`}
                    />
                    <p class="av-form-hint" x-text="`${(formData.callToActionText || '').length} / ${PORTFOLIO_MAX.ctaText}`"></p>
                    <div class="av-portfolio-form-grid">
                      <AvInput label="Email" type="email" name="contact-email" x-model="formData.email" maxlength={PORTFOLIO_MAX.profileEmail} @input={`enforceLimit('email', ${PORTFOLIO_MAX.profileEmail})`} />
                      <AvInput label="Website" type="url" name="contact-website" x-model="formData.website" maxlength={PORTFOLIO_MAX.profileWebsite} @input={`enforceLimit('website', ${PORTFOLIO_MAX.profileWebsite})`} />
                    </div>
                    <AvTextarea
                      label="Links (one per line: Label | URL)"
                      name="contact-links"
                      rows={4}
                      x-model="formData.links"
                      @input={`enforceLineLimit('links', ${PORTFOLIO_MAX.linkLabel + PORTFOLIO_MAX.linkUrl + 3}, 8)`}
                    />
                  </form>
                </template>

                <template x-if="activeSectionKey === 'featuredProjects'">
                  <div class="av-auth-stack-sm">
                    <div class="av-portfolio-item-list">
                      <template x-for="item in activeSectionItems" :key="item.id">
                        <div class="av-portfolio-item-row">
                          <div>
                            <p class="av-text-strong" x-text="itemLabel(item)"></p>
                            <p class="av-text-soft">Featured project</p>
                          </div>
                          <div class="av-portfolio-item-actions">
                            <AvButton variant="ghost" size="sm" type="button" @click.prevent="editItem(item)">Edit</AvButton>
                            <AvButton variant="ghost" size="sm" type="button" @click.prevent="deleteItem(item.id)">Delete</AvButton>
                          </div>
                        </div>
                      </template>
                    </div>
                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveSection()">
                      <AvInput label="Project name" name="project-name" x-model="formData.name" maxlength={PORTFOLIO_MAX.projectName} @input={`enforceLimit('name', ${PORTFOLIO_MAX.projectName})`} />
                      <AvInput label="Project link" type="url" name="project-link" x-model="formData.link" maxlength={PORTFOLIO_MAX.projectLink} @input={`enforceLimit('link', ${PORTFOLIO_MAX.projectLink})`} />
                      <AvTextarea label="Description" name="project-description" rows={3} x-model="formData.description" maxlength={PORTFOLIO_MAX.projectDescription} @input={`enforceLimit('description', ${PORTFOLIO_MAX.projectDescription})`} />
                      <p class="av-form-hint" x-text="`${(formData.description || '').length} / ${PORTFOLIO_MAX.projectDescription}`"></p>
                      <div class="av-portfolio-date-grid">
                        <AvSelect label="Start year" name="project-start-year" x-model="formData.startYear">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvSelect label="Start month" name="project-start-month" x-model="formData.startMonth">
                          <option value="">Select month</option>
                          {monthOptions.map((month) => <option value={month.value}>{month.label}</option>)}
                        </AvSelect>
                        <AvSelect label="End year" name="project-end-year" x-model="formData.endYear" :disabled="formData.isPresent">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvSelect label="End month" name="project-end-month" x-model="formData.endMonth" :disabled="formData.isPresent">
                          <option value="">Select month</option>
                          {monthOptions.map((month) => <option value={month.value}>{month.label}</option>)}
                        </AvSelect>
                      </div>
                      <label class="av-inline-check av-text-soft">
                        <input class="av-checkbox" type="checkbox" x-model="formData.isPresent" @change="togglePresent()" />
                        <span>Present</span>
                      </label>
                      <AvTextarea label="Bullets (one per line)" name="project-bullets" rows={3} x-model="formData.bullets" @input={`enforceLineLimit('bullets', ${PORTFOLIO_MAX.bulletLine}, ${PORTFOLIO_LIMITS.projectBulletsMax})`} />
                      <p class="av-form-hint">Max {PORTFOLIO_LIMITS.projectBulletsMax} bullets, {PORTFOLIO_MAX.bulletLine} chars each.</p>
                      <AvInput label="Tags (comma separated)" name="project-tags" x-model="formData.tags" @input={`enforceTagsLimit('tags', ${PORTFOLIO_MAX.tag}, ${PORTFOLIO_LIMITS.projectTagsMax})`} />
                      <div class="av-row-wrap">
                        <AvButton type="submit" :disabled="loading" x-text="editingItemId ? 'Update project' : 'Add project'"></AvButton>
                      </div>
                    </form>
                  </div>
                </template>

                <template x-if="activeSectionKey === 'experience'">
                  <div class="av-auth-stack-sm">
                    <div class="av-portfolio-item-list">
                      <template x-for="item in activeSectionItems" :key="item.id">
                        <div class="av-portfolio-item-row">
                          <div>
                            <p class="av-text-strong" x-text="itemLabel(item)"></p>
                            <p class="av-text-soft">Experience entry</p>
                          </div>
                          <div class="av-portfolio-item-actions">
                            <AvButton variant="ghost" size="sm" type="button" @click.prevent="editItem(item)">Edit</AvButton>
                            <AvButton variant="ghost" size="sm" type="button" @click.prevent="deleteItem(item.id)">Delete</AvButton>
                          </div>
                        </div>
                      </template>
                    </div>
                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveSection()">
                      <div class="av-portfolio-form-grid">
                        <AvInput label="Role" name="role" x-model="formData.role" maxlength={PORTFOLIO_MAX.experienceRole} @input={`enforceLimit('role', ${PORTFOLIO_MAX.experienceRole})`} />
                        <AvInput label="Company" name="company" x-model="formData.company" maxlength={PORTFOLIO_MAX.experienceCompany} @input={`enforceLimit('company', ${PORTFOLIO_MAX.experienceCompany})`} />
                      </div>
                      <div class="av-portfolio-date-grid">
                        <AvSelect label="Start year" name="experience-start-year" x-model="formData.startYear">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvSelect label="Start month" name="experience-start-month" x-model="formData.startMonth">
                          <option value="">Select month</option>
                          {monthOptions.map((month) => <option value={month.value}>{month.label}</option>)}
                        </AvSelect>
                        <AvSelect label="End year" name="experience-end-year" x-model="formData.endYear" :disabled="formData.isPresent">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvSelect label="End month" name="experience-end-month" x-model="formData.endMonth" :disabled="formData.isPresent">
                          <option value="">Select month</option>
                          {monthOptions.map((month) => <option value={month.value}>{month.label}</option>)}
                        </AvSelect>
                      </div>
                      <label class="av-inline-check av-text-soft">
                        <input class="av-checkbox" type="checkbox" x-model="formData.isPresent" @change="togglePresent()" />
                        <span>Present</span>
                      </label>
                      <AvInput label="Location" name="location" x-model="formData.location" maxlength={PORTFOLIO_MAX.experienceLocation} @input={`enforceLimit('location', ${PORTFOLIO_MAX.experienceLocation})`} />
                      <AvTextarea label="Highlights (one per line)" name="bullets" rows={3} x-model="formData.bullets" @input={`enforceLineLimit('bullets', ${PORTFOLIO_MAX.bulletLine}, ${PORTFOLIO_LIMITS.experienceBulletsMax})`} />
                      <p class="av-form-hint">Max {PORTFOLIO_LIMITS.experienceBulletsMax} bullets, {PORTFOLIO_MAX.bulletLine} chars each.</p>
                      <div class="av-row-wrap">
                        <AvButton type="submit" :disabled="loading" x-text="editingItemId ? 'Update experience' : 'Add experience'"></AvButton>
                      </div>
                    </form>
                  </div>
                </template>

                <template x-if="activeSectionKey === 'education'">
                  <div class="av-auth-stack-sm">
                    <div class="av-portfolio-item-list">
                      <template x-for="item in activeSectionItems" :key="item.id">
                        <div class="av-portfolio-item-row">
                          <div>
                            <p class="av-text-strong" x-text="itemLabel(item)"></p>
                            <p class="av-text-soft">Education entry</p>
                          </div>
                          <div class="av-portfolio-item-actions">
                            <AvButton variant="ghost" size="sm" type="button" @click.prevent="editItem(item)">Edit</AvButton>
                            <AvButton variant="ghost" size="sm" type="button" @click.prevent="deleteItem(item.id)">Delete</AvButton>
                          </div>
                        </div>
                      </template>
                    </div>
                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveSection()">
                      <div class="av-portfolio-form-grid">
                        <AvInput label="Degree" name="degree" x-model="formData.degree" maxlength={PORTFOLIO_MAX.educationDegree} @input={`enforceLimit('degree', ${PORTFOLIO_MAX.educationDegree})`} />
                        <AvInput label="Field" name="field" x-model="formData.field" maxlength={PORTFOLIO_MAX.educationField} @input={`enforceLimit('field', ${PORTFOLIO_MAX.educationField})`} />
                      </div>
                      <AvInput label="Institution" name="institution" x-model="formData.institution" maxlength={PORTFOLIO_MAX.educationInstitution} @input={`enforceLimit('institution', ${PORTFOLIO_MAX.educationInstitution})`} />
                      <div class="av-portfolio-date-grid">
                        <AvSelect label="Start year" name="education-start-year" x-model="formData.startYear">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvSelect label="Start month" name="education-start-month" x-model="formData.startMonth">
                          <option value="">Select month</option>
                          {monthOptions.map((month) => <option value={month.value}>{month.label}</option>)}
                        </AvSelect>
                        <AvSelect label="End year" name="education-end-year" x-model="formData.endYear">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvSelect label="End month" name="education-end-month" x-model="formData.endMonth">
                          <option value="">Select month</option>
                          {monthOptions.map((month) => <option value={month.value}>{month.label}</option>)}
                        </AvSelect>
                      </div>
                      <AvInput label="Grade" name="grade" x-model="formData.grade" maxlength={PORTFOLIO_MAX.educationGrade} @input={`enforceLimit('grade', ${PORTFOLIO_MAX.educationGrade})`} />
                      <div class="av-row-wrap">
                        <AvButton type="submit" :disabled="loading" x-text="editingItemId ? 'Update education' : 'Add education'"></AvButton>
                      </div>
                    </form>
                  </div>
                </template>

                <template x-if="activeSectionKey === 'certifications'">
                  <div class="av-auth-stack-sm">
                    <div class="av-portfolio-item-list">
                      <template x-for="item in activeSectionItems" :key="item.id">
                        <div class="av-portfolio-item-row">
                          <div>
                            <p class="av-text-strong" x-text="itemLabel(item)"></p>
                            <p class="av-text-soft">Certification</p>
                          </div>
                          <div class="av-portfolio-item-actions">
                            <AvButton variant="ghost" size="sm" type="button" @click.prevent="editItem(item)">Edit</AvButton>
                            <AvButton variant="ghost" size="sm" type="button" @click.prevent="deleteItem(item.id)">Delete</AvButton>
                          </div>
                        </div>
                      </template>
                    </div>
                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveSection()">
                      <div class="av-portfolio-form-grid">
                        <AvInput label="Title" name="title" x-model="formData.title" maxlength={PORTFOLIO_MAX.certificationTitle} @input={`enforceLimit('title', ${PORTFOLIO_MAX.certificationTitle})`} />
                        <AvInput label="Issuer" name="issuer" x-model="formData.issuer" maxlength={PORTFOLIO_MAX.certificationIssuer} @input={`enforceLimit('issuer', ${PORTFOLIO_MAX.certificationIssuer})`} />
                      </div>
                      <div class="av-portfolio-form-grid">
                        <AvSelect label="Year" name="year" x-model="formData.year">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvInput label="Note" name="note" x-model="formData.note" maxlength={PORTFOLIO_MAX.note} @input={`enforceLimit('note', ${PORTFOLIO_MAX.note})`} />
                      </div>
                      <div class="av-row-wrap">
                        <AvButton type="submit" :disabled="loading" x-text="editingItemId ? 'Update certification' : 'Add certification'"></AvButton>
                      </div>
                    </form>
                  </div>
                </template>

                <template x-if="activeSectionKey === 'achievements'">
                  <div class="av-auth-stack-sm">
                    <div class="av-portfolio-item-list">
                      <template x-for="item in activeSectionItems" :key="item.id">
                        <div class="av-portfolio-item-row">
                          <div>
                            <p class="av-text-strong" x-text="itemLabel(item)"></p>
                            <p class="av-text-soft">Achievement</p>
                          </div>
                          <div class="av-portfolio-item-actions">
                            <AvButton variant="ghost" size="sm" type="button" @click.prevent="editItem(item)">Edit</AvButton>
                            <AvButton variant="ghost" size="sm" type="button" @click.prevent="deleteItem(item.id)">Delete</AvButton>
                          </div>
                        </div>
                      </template>
                    </div>
                    <form class="av-auth-stack-sm" @submit.prevent="saveActiveSection()">
                      <div class="av-portfolio-form-grid">
                        <AvInput label="Title" name="title" x-model="formData.title" maxlength={PORTFOLIO_MAX.certificationTitle} @input={`enforceLimit('title', ${PORTFOLIO_MAX.certificationTitle})`} />
                        <AvInput label="Issuer" name="issuer" x-model="formData.issuer" maxlength={PORTFOLIO_MAX.certificationIssuer} @input={`enforceLimit('issuer', ${PORTFOLIO_MAX.certificationIssuer})`} />
                      </div>
                      <div class="av-portfolio-form-grid">
                        <AvSelect label="Year" name="year" x-model="formData.year">
                          <option value="">Select year</option>
                          {yearOptions.map((year) => <option value={year}>{year}</option>)}
                        </AvSelect>
                        <AvInput label="Note" name="note" x-model="formData.note" maxlength={PORTFOLIO_MAX.note} @input={`enforceLimit('note', ${PORTFOLIO_MAX.note})`} />
                      </div>
                      <div class="av-row-wrap">
                        <AvButton type="submit" :disabled="loading" x-text="editingItemId ? 'Update achievement' : 'Add achievement'"></AvButton>
                      </div>
                    </form>
                  </div>
                </template>

                <template x-if="error">
                  <div class="av-alert av-alert-danger" role="status" x-text="error"></div>
                </template>
                <template x-if="warning">
                  <div class="av-alert av-alert-warning" role="status" x-text="warning"></div>
                </template>
                <template x-if="success">
                  <div class="av-alert av-alert-success" role="status" x-text="success"></div>
                </template>

                <template x-if="activeSectionKey && activeSection">
                  <div class="av-portfolio-drawer-footer">
                    <div class="av-portfolio-drawer-footer__action" x-show="!['featuredProjects', 'experience', 'education', 'certifications', 'achievements'].includes(activeSectionKey)">
                      <AvButton type="button" @click.prevent="saveActiveSection()" :disabled="loading">
                        <span x-text="`Save ${getSectionLabel(activeSectionKey).toLowerCase()}`"></span>
                      </AvButton>
                    </div>
                    <div class="av-portfolio-drawer-footer__action">
                      <AvButton
                        type="button"
                        variant="ghost"
                        @click.prevent="toggleSectionEnabled(activeSection.id, !activeSection.isEnabled)"
                        :disabled="loading"
                      >
                        <span x-text="activeSection.isEnabled ? 'Hide section' : 'Show section'"></span>
                      </AvButton>
                    </div>
                    <div class="av-portfolio-drawer-footer__action">
                      <AvButton type="button" variant="ghost" @click.prevent="closeDrawer()" :disabled="loading">Close</AvButton>
                    </div>
                  </div>
                </template>
              </div>
            </AvDrawer>
          </div>
        </template>
      </div>
    </AvContainer>
  </section>

</AppShell>
