---
import {
  AvButton,
  AvCard,
  AvConfirmDialog,
  AvContainer,
  AvEmptyState,
  AvInput,
} from "@ansiversa/components";
import { actions } from "astro:actions";
import AppShell from "../../../layouts/AppShell.astro";
import { TEMPLATE_OPTIONS } from "../../../modules/portfolio-creator/helpers";
import type { PortfolioProjectDTO } from "../../../modules/portfolio-creator/types";

const title = "Your Portfolios â€“ Portfolio Creator";
const description = "Create and manage your portfolios.";
const isPaid = Astro.locals.user?.isPaid === true;

const listResult = await Astro.callAction(actions.portfolioCreator.listProjects, {});
const data = (listResult as any)?.data ?? (listResult as any) ?? {};
const projects = (data?.items ?? []) as PortfolioProjectDTO[];

const initialState = {
  projects,
  isPaid,
  paywallMessage: null,
  newProject: {
    title: "",
    themeKey: TEMPLATE_OPTIONS[0].key,
  },
  pendingDeleteId: null,
};
---

<AppShell title={title} description={description}>
  <section class="av-section">
    <AvContainer>
      <div
        class="av-auth-stack-lg"
        x-data="$store.portfolioCreator"
        x-init="init && init(JSON.parse($el.dataset.initial))"
        data-initial={JSON.stringify(initialState)}
      >
        <AvCard className="av-auth-card">
          <div class="av-auth-stack-md">
            <div class="av-auth-stack-xs">
              <p class="av-kicker">Portfolio Creator</p>
              <h1 class="av-section-title">Your portfolios</h1>
              <p class="av-text-soft">Create a new portfolio or continue editing an existing one.</p>
            </div>

            <form class="av-auth-stack-sm" @submit.prevent="createProject()">
              <AvInput
                label="Portfolio title"
                name="portfolio-title"
                placeholder="e.g. Product Designer Portfolio"
                x-model="newProject.title"
                required
              />
              <div class="pc-template-picker">
                <template x-for="template in templateOptions" :key="template.key">
                  <button
                    class="pc-template-option"
                    :class="newProject.themeKey === template.key ? 'is-selected' : ''"
                    type="button"
                    @click.prevent="selectNewTemplate(template.key)"
                    :disabled="isTemplateLocked(template.key)"
                  >
                    <div class="pc-template-option__head">
                      <p class="pc-template-option__title" x-text="template.label"></p>
                      <span class="av-badge av-badge-soft" x-show="template.tier === 'pro' && !isPaid" x-cloak>Pro</span>
                    </div>
                    <p class="pc-template-option__meta" x-text="template.tier === 'pro' ? 'Included in Pro' : 'Free access'"></p>
                  </button>
                </template>
              </div>
              <div class="pc-paywall" x-show="paywallMessage" x-cloak>
                <p class="av-text-soft av-m-0" x-text="paywallMessage"></p>
                <AvButton href="https://ansiversa.com/pricing" variant="ghost" size="sm">
                  View pricing
                </AvButton>
              </div>
              <div class="av-row-wrap">
                <AvButton type="submit" :disabled="loading">Create portfolio</AvButton>
              </div>
            </form>

            <template x-if="error">
              <div class="av-alert av-alert-danger" role="status" x-text="error"></div>
            </template>
            <template x-if="success">
              <div class="av-alert av-alert-success" role="status" x-text="success"></div>
            </template>
          </div>
        </AvCard>

        <AvCard variant="soft" className="av-auth-stack-md">
          <div class="av-row-between">
            <h2 class="av-card-heading">Portfolio list</h2>
            <p class="av-text-soft" x-text="projects.length + ' total'"></p>
          </div>

          <template x-if="projects.length === 0">
            <AvEmptyState
              headline="No portfolios yet"
              description="Create your first portfolio to start editing."
            />
          </template>

          <template x-if="projects.length > 0">
            <div class="av-portfolio-grid">
              <template x-for="project in projects" :key="project.id">
                <AvCard variant="soft" className="av-card--fullheight">
                  <div class="av-auth-stack-sm">
                    <div class="av-auth-stack-xxs">
                      <div class="av-portfolio-card__head">
                        <h3 class="av-card-heading" x-text="project.title"></h3>
                        <template x-if="project.isPublished">
                          <span class="av-badge av-badge-soft">Published</span>
                        </template>
                      </div>
                      <div class="av-portfolio-meta">
                        <span x-text="`/${project.slug}`"></span>
                        <span x-text="`Visibility: ${project.visibility}`"></span>
                        <span x-text="`Status: ${project.isPublished ? 'Published' : 'Draft'}`"></span>
                        <span x-text="project.updatedAt ? `Updated: ${new Date(project.updatedAt).toLocaleDateString()}` : ''"></span>
                      </div>
                    </div>

                    <div class="av-row-wrap">
                      <AvButton
                        variant="ghost"
                        size="sm"
                        href="#"
                        x-bind:href="`/app/portfolios/${project.id}`"
                      >
                        Edit
                      </AvButton>
                      <AvButton
                        variant="ghost"
                        size="sm"
                        href="#"
                        x-bind:href="`/${project.slug}`"
                        target="_blank"
                      >
                        View public
                      </AvButton>
                      <AvButton
                        variant="ghost"
                        size="sm"
                        type="button"
                        @click.prevent="pendingDeleteId = project.id; window.AvDialog?.open('portfolio-delete-dialog')"
                        :disabled="loading"
                      >
                        Delete
                      </AvButton>
                    </div>
                  </div>
                </AvCard>
              </template>
            </div>
          </template>
        </AvCard>

        <AvConfirmDialog
          id="portfolio-delete-dialog"
          headline="Delete portfolio?"
          description="This action cannot be undone."
          confirmLabel="Delete"
          cancelLabel="Cancel"
          variant="danger"
          @av-confirm="pendingDeleteId && deleteProject(pendingDeleteId)"
          @av-cancel="pendingDeleteId = null"
        />
      </div>
    </AvContainer>
  </section>

  <style>
    .pc-template-picker {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
    }

    .pc-template-option {
      text-align: left;
      padding: 0.85rem 1rem;
      border-radius: 0.85rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: #0b1220;
      color: #e2e8f0;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      transition: border 0.2s ease, transform 0.2s ease;
    }

    .pc-template-option__head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .pc-template-option__title {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .pc-template-option__meta {
      font-size: 0.75rem;
      color: rgba(148, 163, 184, 0.85);
      margin: 0;
    }

    .pc-template-option:hover {
      border-color: rgba(14, 165, 233, 0.6);
      transform: translateY(-1px);
    }

    .pc-template-option.is-selected {
      border-color: rgba(14, 165, 233, 0.9);
      background: rgba(14, 116, 144, 0.2);
    }

    .pc-template-option:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .pc-paywall {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }
  </style>
</AppShell>
